# **Práctica 2.5. Manejo del tiempo: Temporizadores**

## **Objetivo**

1. Introducir al estudiante en el uso del periférico GPTimer o *General Purpose Timer*, haciendo uso de las funciones proporcionadas por la HAL del fabricante.

## **Materiales**

***Hardware***

- 1 Computador.
- 1 Placa de desarrollo basada en ESP32 (cualquiera que tenga a disposición).
- 1 Cable de programación.
- 1 Protoboard.


***Software***

- IDE *Visual Studio Code (VSCode)*, 
- Extensión de VSCode *PlatformIO*. A través de esta extensión tiene acceso a:
	- Framework ESP-IDF que esencialmente contiene la API (bibliotecas de software y código fuente) para la ESP32 y scripts para operar la *Toolchain* para compilar código.
	- Herramientas de compilación para crear una aplicación completa para ESP32.
		- CMake, and 
		- Ninja.
- [Hercules](https://www.hw-group.com/software/hercules-setup-utility).

Para realizar una instalación limpia de este software, por favor vaya a la [Guía de instalación](1.9_guia_instal_tools.md).

### **Ejercicio introductorio**

Por favor, siga la siguiente metodología.

1. Inicie el programa VSCode y cree un nuevo proyecto con la herramienta platformIO siguiendo los pasos de la sección [Crear un nuevo proyecto con platformIO](/Unidad_1/0_nuevo_proyecto.md).
	
2. Cuando se haya creado el proyecto, despliegue la carpeta "src", donde está el archivo "main.c" que es el archivo principal del proyecto. En este archivo se escribirá el programa. 

3. Escriba el siguiente código dentro del archivo "main.c", cuyo objetivo es: 
	1. Crear un temporizador de propósito general.
	1. Leer el valor del temporizador cada un segundo.
	1. Mostrar el valor leído a través del puerto serie.

	~~~
	// Incluir bibliotecas standar de C 
	#include <stdio.h>   
	#include <string.h>  

	// Incluir biblioteca de control de pines GPIO del ESP-IDF
	#include "driver/gpio.h"       

	// Incluir biblioteca de control de GPTimer del ESP-IDF
	#include "driver/gptimer.h"

	// Incluir biblioteca del sistema operativo FreeRTOS
	#include "freertos/FreeRTOS.h" 
	  
	// Incluir biblioteca para manejo de tareas del FreeRTOS
	#include "freertos/task.h" 


	// Inicializar una instancia del temporizador GPTimer
	gptimer_handle_t gptimer = NULL;

	// Inicializar la estructura para configurar el temporizador
	gptimer_config_t timer_config = {

		.clk_src = GPTIMER_CLK_SRC_APB,
		.direction = GPTIMER_COUNT_UP,
		.resolution_hz = 1000000, // 1MHz, 1 tick = 1us
		
	};

	void app_main(){

		// Configurar el temporizador según a estructura "timer_config",
		// creada anteriormente. 
		ESP_ERROR_CHECK(gptimer_new_timer(&timer_config, &gptimer));

		// Habilita el temporizador
		ESP_ERROR_CHECK(gptimer_enable(gptimer));

		// Inicia el conteo del temporizador
		ESP_ERROR_CHECK(gptimer_start(gptimer));

		// Variable para almacenar el valor leído en el temporizador
		uint64_t timer_val;

		// Lectura del valor del temporizador
		ESP_ERROR_CHECK(gptimer_get_raw_count(gptimer, &timer_val));

		// Este bloque genera una lectura continua
		while(1){

			// Lectura del valor del temporizador
			ESP_ERROR_CHECK(gptimer_get_raw_count(gptimer, &timer_val));

			// Imprime por serial el valor leído
			printf("El valor leido es: %llu\n", timer_val);

			// Espera un segundo
			vTaskDelay( 1000 / portTICK_PERIOD_MS);
		}

	}

	~~~

4. La configuración del hardware que usted debe tener es la siguiente:
	
	- Sólo necesita mantener conectado el cable de programación al computador y a la placa.

5. En la parte inferior de Visual Studio Code hay una serie de botones, se describen los más relevantes:

	<img src="/Unidad_1/imagenes/1.10_barra_inferior_platformIO.png" width=500>

	*Barra de herramientas de PlatformIO.*

	1. *"Build"*. Compilar el proyecto.
	1. *"Upload"*. Cargar el proyecto a la placa.
	1. *"Serial monitor"*. Abrir un monitor serial.


6. Compile el proyecto usando el botón *"Build"*. La primera vez puede ser demorado ya que crea todos los archivos del proyecto. Si todo es correcto, se obtiene un mensaje similar al siguiente:

	<img src="/Unidad_1/imagenes/1.10_pront_build_programa.png" width=500>
	
7. Luego dar clic en *"Upload"* para subir el programa a la placa Si todo es correcto, se obtiene un mensaje similar al siguiente:

	<img src="/Unidad_1/imagenes/1.10_pront_carga_programa.png" width=500>

8. Luego puede usar cualquier programa para leer el puerto serial del computador. Sin embargo, se le recomienda [Hercules](https://www.hw-group.com/software/hercules-setup-utility). 
	- Hercules es un software portable (no requiere instalación). Para los usuarios de Windows, luego de descargar el archivo, para ejecutarlo puede hacer doble clic.
	- Al ejecutarlo, se le mostrará la siguiente vista:

		<img src="/Unidad_1/imagenes/1.10.2_Hercules_1.png" width=500>

	- Vaya a la pestaña "Serial" que se encuentra en la parte superior izquierda de la ventana de Hercules. De clic en ella y se mostrará la siguiente vista:

		<img src="/Unidad_1/imagenes/1.10.2_Hercules_2.png" width=500>

	- Luego, en el panel derecho denominado "Serial", configure la comunicación UART. En esta guía no se profundizará en la comunicación UART, que se dejará para guías posteriores. Simplemente, siga las siguientes recomendaciones:
		- Elija el Puerto COM al que está conectada la tarjeta ESP32. Para los usuarios de Windows, esto lo puede averiguar en la "Administración de Dispositivos".
		- Luego configure cada uno de los campos como se muestra a continuación:

			<img src="/Unidad_1/imagenes/1.10.2_Hercules_3.png" width=200>

	- Posteriormente, de clic en el botón Open del panel "Serial". Esto abrirá el puerto serie y podrá transmitir y recibir con la placa ESP32 a través de comunicación UART. La salida debería ser:
	
	<img src="/Unidad_2/imagenes/2.5_salida_serie_ejercicio_introductorio.png" width=500>
	

## **Práctica**

### P1. 

Usando 


# Referencias

- [1] 